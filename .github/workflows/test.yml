name: ì•”í˜¸í™”í ë¶„ì„ í”„ë¡œì íŠ¸ í…ŒìŠ¤íŠ¸

# íŠ¸ë¦¬ê±° ì„¤ì •
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # ë§¤ì¼ UTC 00:00 (í•œêµ­ì‹œê°„ 09:00)ì— ì‹¤í–‰
    - cron: '0 0 * * *'

# í™˜ê²½ ë³€ìˆ˜
env:
  PYTHON_VERSION: '3.9'
  TESTING: 'true'

jobs:
  # ë¦°íŠ¸ ë° ì •ì  ë¶„ì„
  lint:
    name: ë¦°íŠ¸ ë° ì •ì  ë¶„ì„
    runs-on: ubuntu-latest

    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ì˜ì¡´ì„± ìºì‹œ
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-lint-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-lint-
          ${{ runner.os }}-pip-

    - name: ë¦°íŠ¸ ë„êµ¬ ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black mypy

    - name: ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ (Black)
      run: |
        black --check --diff src/ utils/ config/ tests/

    - name: ë¦°íŠ¸ ê²€ì‚¬ (Flake8)
      run: |
        flake8 src/ utils/ config/ tests/ --max-line-length=88 --extend-ignore=E203,W503

    - name: íƒ€ì… ê²€ì‚¬ (MyPy)
      run: |
        mypy src/ utils/ config/ --ignore-missing-imports

  # ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
  unit-tests:
    name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: lint

    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Python ${{ matrix.python-version }} ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ì˜ì¡´ì„± ìºì‹œ
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r tests/requirements-test.txt

    - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        python -m pytest tests/unit/ -v --tb=short --cov=src --cov=utils --cov=config

    - name: ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
      if: matrix.python-version == '3.9'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # í†µí•© í…ŒìŠ¤íŠ¸
  integration-tests:
    name: í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r tests/requirements-test.txt

    - name: í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        python -m pytest tests/integration/ -v --tb=short
      env:
        # API í˜¸ì¶œ ì œí•œì„ ìœ„í•œ í™˜ê²½ ë³€ìˆ˜
        API_RATE_LIMIT: '1'
        API_TIMEOUT: '10'

  # E2E í…ŒìŠ¤íŠ¸
  e2e-tests:
    name: E2E í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: integration-tests

    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r tests/requirements-test.txt

    - name: E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        python -m pytest tests/e2e/ -v --tb=short --durations=10
      env:
        # E2E í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ í™˜ê²½ ë³€ìˆ˜
        E2E_TESTING: 'true'
        API_RATE_LIMIT: '0.5'

  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (ì„ íƒì )
  performance-tests:
    name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[perf]')
    needs: e2e-tests

    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r tests/requirements-test.txt

    - name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        python -m pytest tests/ -v --tb=short -m slow --benchmark-only

    - name: ë²¤ì¹˜ë§ˆí¬ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: tests/benchmark_results.json

  # ì „ì²´ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
  test-summary:
    name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, e2e-tests]
    if: always()

    steps:
    - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ í™•ì¸
      run: |
        echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½"
        echo "==================="
        echo "ë¦°íŠ¸: ${{ needs.lint.result }}"
        echo "ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: ${{ needs.unit-tests.result }}"
        echo "í†µí•© í…ŒìŠ¤íŠ¸: ${{ needs.integration-tests.result }}"
        echo "E2E í…ŒìŠ¤íŠ¸: ${{ needs.e2e-tests.result }}"

        if [[ "${{ needs.lint.result }}" == "success" &&
              "${{ needs.unit-tests.result }}" == "success" &&
              "${{ needs.integration-tests.result }}" == "success" &&
              "${{ needs.e2e-tests.result }}" == "success" ]]; then
          echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!"
          exit 0
        else
          echo "âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          exit 1
        fi

  # ë³´ì•ˆ ìŠ¤ìº” (ì„ íƒì )
  security-scan:
    name: ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ë³´ì•ˆ ë„êµ¬ ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit

    - name: ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬
      run: |
        safety check --json --output safety-report.json || true

    - name: ì½”ë“œ ë³´ì•ˆ ê²€ì‚¬
      run: |
        bandit -r src/ utils/ config/ -f json -o bandit-report.json || true

    - name: ë³´ì•ˆ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          safety-report.json
          bandit-report.json